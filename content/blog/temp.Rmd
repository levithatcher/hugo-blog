---
title: "Year-over-year SLC pollution comparisons using multiple sites"
excerpt: "Are the winters getting better?"
date: '2018-01-11'
draft: true
showpagemeta: true
---
  
```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, 
                      echo = TRUE, dev = 'png',
                      dpi = 200, out.width='650px', fig.width=8, fig.height=4)
```

Let's look at 2013-2017 **daily** data to compare Rose Park (49-035-3010) and Hawthorne Elementary (49-035-3006), both of which are in SLC proper and X miles apart as the crow flies.


```{r, include=FALSE}
library(tidyverse)
df3 <- read_csv('../data/SLCFiveSitesDaily2013.csv')
df4 <- read_csv('../data/SLCFiveSitesDaily2014.csv')
df5 <- read_csv('../data/SLCFiveSitesDaily2015.csv')
df6 <- read_csv('../data/SLCFiveSitesDaily2016.csv')
df7 <- read_csv('../data/SLCFiveSitesDaily2017.csv')

df <- dplyr::bind_rows(df3,df4,df5,df6,df7)

# Strip out sites that aren't Rose Park/Hawthorne
df <- df %>%
  filter(AQS_SITE_ID == 490353010 | AQS_SITE_ID == 490353006)
```

For brevity, we've loaded in our data and now will trim out the sites that aren't Hawthorne / Rose Park, and only grab only the columns necessary.

```{r}
dfinal <- df %>% 
  # Hawthorne has several options; grab the most complete record
  filter(POC == 1) %>%
  filter(AQS_PARAMETER_DESC == 'PM2.5 - Local Conditions') %>%
  # Change the Site column to be more readable
  mutate(Site = ifelse(AQS_SITE_ID == 490353006, 'Hawthorne', 'Rose Park')) %>% 
  mutate(Date = as.Date(Date, format="%m/%d/%Y")) %>%
  rename(Measurement = `Daily Mean PM2.5 Concentration`) %>%
  select(Date, Site, Measurement) %>%
  arrange(Date)

# Look at the data
print(dfinal, 3)
```

While we'd expect roughly 1826 daily measurements over five years, we have less than that (but still enough to work with).

```{r}
dfinal %>% 
  group_by(Site) %>% 
  summarize(`Measurements Per Site` = length(Measurement))
```

Now that we have a simple two-site table to work with, let's see how well the measurements correspond. First, let's pivot the table to and [compute](https://stackoverflow.com/a/4862334) a running average for both Rose Park and Hawthorne.

```{r}
df_pivot <- dfinal %>% 
  tidyr::spread(Site, Measurement)

# Compute 3-day moving average
ma <- function(x, n = 3) {
  stats::filter(x, rep(1/n, n), sides = 2)
}

df_pivot$`Hawthorne MA` <- ma(df_pivot$Hawthorne)

df_pivot$`Rose Park MA` <- ma(df_pivot$`Rose Park`)

```


Now that we have the two moving averages, let's compare via ggplot2.

```{r}
library(scales)
ggplot(df_pivot, aes(x = Date)) +
  geom_line(aes(y = `Hawthorne MA`, colour = "Hawthorne")) +
  geom_line(aes(y = `Rose Park MA`, colour = "Rose Park")) +
  labs(title = "3-Day Running Average PM2.5 in SLC from 2013 - 2017") +
  scale_colour_manual(values = c("black", "red")) +
  scale_y_log10(name = "PM2.5 Âµg/m3", 
                limits = c(1,NA), 
                breaks = c(1,20,40,60,80,100)) +
  scale_x_date(name = "Year", 
               labels = date_format("%Y-%m-%d"), 
               breaks = date_breaks("1 year"))

```

While the missing data is annoying, it indeed _looks_ like there is good agreement between the Hawthorne and Rose Park daily PM2.5 values from 2013-2017. Interesting that occasionally both sites are missing data while other times they complement each other's failings (wohoo!).