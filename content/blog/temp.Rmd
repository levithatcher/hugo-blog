---
title: "Year-over-year SLC pollution comparisons using multiple sites"
draft: yes
date: '2018-01-11'
showpagemeta: yes
excerpt: Are the winters getting better?
---
  
```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, 
                      echo = TRUE, dev = 'png',
                      dpi = 200, out.width='650px', fig.width=8, fig.height=4)
```

## Background

## The Plan

Let's look at 2012-2017 **daily** data to compare Rose Park (49-035-3010) and Hawthorne Elementary (49-035-3006), both of which are in SLC proper and X miles apart as the crow flies. We download the data from [here](https://www.epa.gov/outdoor-air-quality-data/download-daily-data). 

## Get the data


```{r, include=FALSE}
library(tidyverse)
df2 <- read_csv('../data/SLCFiveSitesDaily2012.csv')
df3 <- read_csv('../data/SLCFiveSitesDaily2013.csv')
df4 <- read_csv('../data/SLCFiveSitesDaily2014.csv')
df5 <- read_csv('../data/SLCFiveSitesDaily2015.csv')
df6 <- read_csv('../data/SLCFiveSitesDaily2016.csv')
df7 <- read_csv('../data/SLCFiveSitesDaily2017.csv')

df <- dplyr::bind_rows(df2,df3,df4,df5,df6,df7)

# Strip out sites that aren't Rose Park/Hawthorne
df <- df %>%
  filter(AQS_SITE_ID == 490353010 | AQS_SITE_ID == 490353006)
```

## The analysis

### Summarize and check the data

For brevity, we've loaded in our data and now will trim out the sites that aren't Hawthorne / Rose Park, and only grab only the columns necessary.

```{r}
dfinal <- df %>% 
  # Hawthorne has several options; grab the most complete record
  filter(POC == 1) %>%
  filter(AQS_PARAMETER_DESC == 'PM2.5 - Local Conditions') %>%
  # Change the Site column to be more readable
  mutate(Site = ifelse(AQS_SITE_ID == 490353006, 'Hawthorne', 'Rose Park')) %>% 
  mutate(Date = as.Date(Date, format="%m/%d/%Y")) %>%
  rename(Measurement = `Daily Mean PM2.5 Concentration`) %>%
  select(Date, Site, Measurement) %>%
  arrange(Date)

# Look at the data
print(dfinal, 3)
```

Let's now count up the average number of observations per year, to see how much data might be missing.

```{r}
dfinal %>% 
  mutate(Year = lubridate::year(Date)) %>% 
  group_by(Site, Year) %>% 
  summarize(`Measurements Per Site` = length(Measurement))
```

Note that we weirdly have fewer than 365 observations per year (but foruntately still enough to work with). Note sure why these sites have such issues--[anyone](https://twitter.com/levithatcher)?

### Running average two-site comparison over time

Now that we have a simple two-site table to work with, let's see how well the measurements correspond. First, let's  pivot the table such that both sites are in their own column and [compute](https://stackoverflow.com/a/4862334) a 3-day running average.


```{r}
df_pivot <- dfinal %>% 
  tidyr::spread(Site, Measurement)

# Compute 3-day moving average
ma <- function(x, n = 3) {
  stats::filter(x, rep(1/n, n), sides = 2)
}

df_pivot$`Hawthorne MA` <- ma(df_pivot$Hawthorne)

df_pivot$`Rose Park MA` <- ma(df_pivot$`Rose Park`)
```

Now we plot the 3-day running average for both Hawthorne and Rose Park.

```{r}
library(scales)
ggplot(df_pivot, aes(x = Date)) +
  geom_line(aes(y = `Hawthorne MA`, colour = "Hawthorne")) +
  geom_line(aes(y = `Rose Park MA`, colour = "Rose Park")) +
  labs(title = "3-Day Running Average PM2.5 in SLC from 2012 - 2017") +
  scale_colour_manual(values = c("black", "red")) +
  scale_y_log10(name = "PM2.5 µg/m3", 
                limits = c(1,NA), 
                breaks = c(1, 5, 10, 15)) +
  scale_x_date(name = "Year", 
               labels = date_format("%Y-%m-%d"), 
               breaks = date_breaks("1 year"))

```

While the missing data is annoying, it indeed _looks_ like there is fairly good agreement between the Hawthorne and Rose Park daily PM2.5 values from 2012-2017. And it indeed appears that for both sites winter air quality has improved since 2013 (more to come below).

### Differences after [loess smoothing](https://en.wikipedia.org/wiki/Local_regression)

Even though Hawthorne and Rose Park both move together, how to they differ? To check longer-term differences, let's plot with a `loess` smoother (which is built into `ggplot2`).

```{r}
ggplot(df_pivot, aes(x = Date)) +
  geom_smooth(aes(y = Hawthorne, colour = "Hawthorne"), method = 'loess') +
  geom_smooth(aes(y = `Rose Park`, colour = "Rose Park"), method = 'loess') +
  labs(title = "Smoothed PM2.5 in SLC from 2013 - 2017") +
  scale_colour_manual(values = c("black", "red")) +
  scale_y_log10(name = "PM2.5 µg/m3", 
                limits = c(5,NA), 
                breaks = c(5, 8, 10, 12, 15)) +
  scale_x_date(name = "Year", 
               labels = date_format("%Y-%m-%d"), 
               breaks = date_breaks("1 year"))

```

Interesting--Rose Park PM2.5 levels are systematically higher than those at Hawthorne Elementary (which is in the Liberty Wells neighborhood). While a background difference between of ~1ug/m3 doesn't seem like much, this smoothing likely hides shorter-term spikes; what's scary is even differences in low-level PM2.5 exposure [can lead to adverse health effects](http://www.nejm.org/doi/full/10.1056/NEJMoa1702747). 

While this isn't confirmed, the heightened PM2.5 levels in Rose Park could come from the local refinery, which is just 1.5 miles east of the air quality measurement site.

![](../figs/temp/map.png)

Now, let's make the year-over-year comparison crystal clear. First for Hawthorne. Note that because we're only comparing winters, we need a winter column that allows us to use faceting in ggplot2 (thanks to [Mike Levy](https://twitter.com/ucdlevy) for the seasonal support here).


```{r}
dividers <- as.Date(paste0(2012:2017, "06", "01"), format = "%Y%m%d")

df_pivot <- df_pivot %>%
  mutate(Season = cut(as.numeric(Date), as.numeric(dividers), 
                      include.lowest = TRUE),
         Season = as.numeric(Season),
         Month = lubridate::month(Date)) %>% 
  filter(Month %in% c(1,2,11,12), # Only care about winter months
         !is.na(Season))          # This avoids an NA facet plot
```

And now we plot the five winters for Hawthorne.

```{r}
# Plot
p <- ggplot(df_pivot, aes(x = Date, y = `Hawthorne`)) + 
  geom_smooth(method = "loess") +
  #geom_point() +
  scale_y_log10(name = "PM2.5 µg/m3", 
                limits = c(2,NA), 
                breaks = c(1, 5, 7, 10, 15, 20, 30, 40, 50)) +
  scale_x_date(name = "Winter Month",
               labels = date_format("%m"),
               breaks = date_breaks("1 month"))
p + facet_grid(. ~ Season, scale = "free")
```

And for Rose Park

```{r}
# Plot
p <- ggplot(df_pivot, aes(x = Date, y = `Rose Park`)) + 
  geom_smooth(method = "loess") +
  #geom_point() +
  scale_y_log10(name = "PM2.5 µg/m3", 
                limits = c(2,NA), 
                breaks = c(1, 5, 7, 10, 15, 20, 30, 40, 50)) +
  scale_x_date(name = "Winter Month",
               labels = date_format("%m"),
               breaks = date_breaks("1 month"))
p + facet_grid(. ~ Season, scale = "free")
```

```{r, eval=FALSE, include=FALSE}
df_pivot %>%
  filter(Year == 2016) %>%
  mutate(Month = format(Date, "%m")) %>% 
  group_by(Month) %>% 
  summarize(mean = mean(Hawthorne, na.rm=TRUE))
```

